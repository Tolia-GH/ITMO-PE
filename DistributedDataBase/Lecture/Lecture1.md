<head>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$']]
            }
        });
    </script>
</head>

## [MainPage](../../index.md)/[Ditributed DataBase](../README.md)/Lecture

# Лекция 

## Лекция 7

### 1. Резервное копирование

Стратегия резервного копирования бывает:
- полная — охватывает всю базу данных;
- частичная — охватывает только часть базы данных.
- Резервная копия может содержать:
- все страницы в пределах выбранных файлов;
- ту информацию, которая изменилась с момента
последнего резервного копирования (инкрементная):
  - кумулятивная (изменения — до последнего уровня 0);
  - дифференциальная (изменения — до последнего
  инкрементного резервного копирования).

Виды резервного копирования:
- «холодное» — создание резервной копии, когда
экземпляр сервера БД остановлен;
- «горячее» — создание резервной копии во время
работы экземпляра сервера БД;

Виды резервного копирования:
- логическое;
- физическое;

### 2. Логическое РК

- Копия объектов БД и структур данных создается в виде команд/предложений языка SQL, сами файлы не копируются.
- Утилиты в PostgreSQL для осуществления логического
резервного копирования/восстановления:
➢ pg_dump (Создание РК)
➢ pg_dumpall (Создание РК)
➢ pg_restore (Восстановление данных из РК)

#### pg_dump

- Служит для создания резервной копии БД или ее части.
- В общем случае создается SQL-файл с командами,
которые позволяют воссоздать логическое состояние
БД на момент создания бэкапа.
- Использование:
  `pg_dump mydb(Имя БД) > mydbdump(Файл с копией)`
  Пример:
  `pg_dump -U postgres1 -f mydbdump mydb`

#### pg_dump: форматы РК
- plain text, текстовый формат — в файле ~SQLпредложения:
➢ можно восстановить, выполнив в psql;
`pg_dump -f mydbdump mydb`
- custom формат:
➢ возможно сжатие (если есть zlib);
➢ бинарный файл;
`pg_dump -Fc -f mydbdump mydb`
- в виде директории — один файл для каждой~таблицы;
`pg_dump -Fd Student -f mydbdump mydb`
- tar — архив РК, в архиве содержимое, как для формата в виде директории;
`pg_dump -Ft Student -f mydbdump mydb`

#### Текстовый формат

- Используется по умолчанию.
- Содержимое — предложения для восстановления логического состояния БД.
- По умолчанию для добавления данных используется PostgreSQL команда COPY.
- Для генерации INSERT:
`pg_dump -U postgres1 --inserts -f mydbdump mydb`
`pg_dump -U postgres1 --column-inserts -f mydbdump mydb`

#### Формат РК в виде директории

`pg_dump -Fd Student -f mydbdump mydb`
- Для отдельных объектов БД создаются отдельные файлы:
➢ возможно сжатие файлов в директории;
- В директории есть файл toc.dat:
➢ индекс для pg_restore;
➢ для поиска файлов внутри директории;

#### Особенности использования pg_dump

- По умолчанию не создаются предложения для создания БД.
- Чтобы восстановить данные нужно подключиться к существующей БД.
- Для добавления создания БД (CREATE DATABASE) можно использовать опцию —create (-C):
➢ при использовании опции в бэкап добавляются предложения для подключения к созданной БД: pg_dump -U postgres1 --create -f mydbdump mydb

#### Получение скрипта для восстановления части БД

Можно задать создание скрипта для восстановления
только определенных таблиц, структуры БД,
содержимого БД:
- pg_dump -t Student -f mydbdump mydb -- only Student
- pg_dump -T Student -f mydbdump mydb -- all except
 -- Student
- pg_dump -a -f mydbdump mydb -- only data
- pg_dump -s -f mydbdump mydb -- only schema (DDL)

#### Восстановление БД

Использование:
`psql mydb < mydbdump`
- Использующиеся в бэкапе пользователи, роли должны существовать/быть воссозданы до запуска скрипта.

#### Ошибки при восстановлении БД

- Чтобы остановить скрипт после возникновения первой ошибки (невыполненного предложения):
`psql --set ON_ERROR_STOP=on mydb < mydbdump`
- Можно указать, чтобы восстановление выполнялось в рамках одной транзакции:
`psql --single-transaction mydb < mydbdump`

#### pg_restore

- Утилита для восстановления данных на основе
скриптов, созданных pg_dump:
`pg_restore -d mydb mydbdump`
- Можно посмотреть список команд, которые будут
исполнены при восстановлении БД:
`pg_restore mydbdump -f test.sql`
- Если используется директория — можно включить свой toc-файл и сделать частичное восстановление.

#### pg_dumpall

- Утилита для создания скриптов восстановления всех БД в кластере:
`pg_dumpall -U postgres1 -f mydbdump`
- Создает SQL-скрипт.
- Кроме БД сохраняются глобальные объекты
(пользователи, роли, табличные пространства).
- Восстановление БД:
`psql -f dumpfile postgres`

#### Осуществление резервного копирования

- Возможен параллельный режим:
pg_dump, опция -j:
➢ можно указать число параллельных процессов.
- Есть готовые скрипты-шаблоны для организации резервного копирования:
https://wiki.postgresql.org/wiki/Automated_Backup_on_Linux