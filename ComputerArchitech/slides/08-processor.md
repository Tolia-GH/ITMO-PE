# Архитектура компьютера

## Лекция 8

### Информационный процессор. <br/> Ключевые термины. <br/> Архитектуры процессоров. <br/> Процессор фон Неймана

Пенской А.В., 2022

----

### План лекции

- Информационный процессор. Универсальный процессор. Виды процессоров
- Архитектуры универсальных процессоров
- Машина Тьюринга
- Редукционные компьютеры (Reduction Machines)
- Потоковые машины (Dataflow Machines)
- Машина фон Неймана

---

## Информационный процессор

<div class="row"><div class="col">

Информационный процессор
: система (электрическая, механическая или биологическая), которая принимает информацию (последовательность символов или состояний) в одной форме и обрабатывает (преобразует) ее в другую форму.

Например: исходный сигнал в статистику, посредством алгоритмического процесса.

</div><div class="col">

![_Information processor by Wikipedia_](../fig/information-processing-system.png)

Система обработки информации состоит из четырех основных частей или подсистем:

1. ввод
1. процессор
1. хранилище
1. вывод

</div></div>

----

### Универсальный процессор (CPU)

HW позволяет решать широкий круг задач, настройка которых производится после производства "по месту" или в run-time.

Примечания:

- Универсальность противоречит эффективности (производительность, энергопотребление).
- Универсальность -- теоретическое свойство.
- Современная аппаратура содержит много ПО.
- Процессор не обязан быть аппаратным.

----

### Свойства универсального (программируемого) процессора

1. отделение "программирования" от этапа "производства"
1. полнота по Тьюрингу
1. отсутствие "серьезных" ограничений на "объём" программы
1. возможность изменения ПО

---

### Виды процессоров

![_Architecture comparison in terms of flexibility, performance, and energy efficiency_ ](../fig/architecture-comparison-flexibility-performance-energy.png)

- Application-Specific Integrated Circuit (ASIC) **(не универсальный)**
- Field-Programmable Gate Array (FPGA, ПЛИС)
- Coarse-Grained Reconfigurable Arrays (CGRA)
- Digital Signal Processor (DSP)
- Graphics Processing Unit (GPU)
- Central Processing Unit (CPU) **(основной акцент)**

----

#### Field-Programmable Gate Array (FPGA)

![](../fig/fpga-internal.png)

----

#### Coarse-Grained Reconfigurable Arrays (CGRA)

![](../fig/proc-cgra-typical.jpg)

----

#### Digital Signal Processor (DSP)

![](../fig/proc-dsp.gif)

----

#### Central Processing Unit (CPU) <br/> Graphics Processing Unit (GPU)

![](../fig/proc-cpu-vs-gpu.png)

---

## Ключевые термины

- [Микро]процессор
- [Микро]контроллер
- Оперативная память
- Встраиваемая/встроенная система (embedded system)
- Система на Кристалле (СнК, System-on-a-Chip, SoC)
- Архитектура процессора (architecture)
- Машинное слово
- Микроархитектура процессора (microarchitecture)
- Система команд процессора

----

<div class="row"><div class="col">

[Микро]процессор
: цифровая схема, которая выполняет операции с некоторым внешним источником данных, обычно памятью или другим потоком данных.

[Микро]контроллер
: микросхема, предназначенная для управления электронными устройствами.
: Типичный микроконтроллер сочетает функции процессора и периферийных устройств, содержит ОЗУ и (или) ПЗУ.

</div><div class="col">

<!-- ![](../fig/microprocessor-and-periph.gif) -->

![](../fig/microcontroller-and-microprocessor.png)

Оперативная память (память)
: обычно часть компьютерной памяти, в которой хранится выполняемый машинный код, а также входные, выходные и промежуточные данные.

</div></div>

----

<div class="row"><div class="col">

Встраиваемая/встроенная система (embedded system)
: специализированная микропроцессорная система управления, контроля и мониторинга, концепция разработки которой заключается в том, что такая система будет работать, будучи встроенной непосредственно в устройство, которым она управляет.

</div><div class="col">

![](../fig/embedded-system-applications.jpg)

Система на Кристалле (СнК, System-on-a-Chip, SoC)
: электронная схема, выполняющая функции целого устройства (например, компьютера) и размещённая на одной интегральной схеме.

</div></div>

----

Архитектура процессора (architecture)
: это то, как видит компьютер программист. Она определена набором команд (языком) и местом нахождения операндов (регистры и память).

- Существует множество разных архитектур: x86, MIPS, SPARC.

- Чтобы понять архитектуру, нужно выучить его язык.

- Слова в языке компьютера называются "инструкциями" или "командами", а словарный запас -- "системой команд".

Машинное слово
: фрагмент данных фиксированного размера, обрабатываемый как единое целое с помощью набора команд или аппаратного обеспечения процессора

----

Микроархитектура процессора (microarchitecture)
: соединение простейших цифровых элементов в логические блоки, предназначенные для выполнения команд, определенных архитектурой.

- Описывает, как в процессоре расположены и соединены друг с другом регистры, АЛУ, конечные автоматы, блоки памяти и т.д.

- У каждой архитектуры может быть много микроархитектур, обеспечивающих разное соотношение производительности, цены и сложности. Они смогут выполнять одни и те же программы.

----

Система команд процессора
: (Instruction Set Architecture -- ISA) абстрактная модель процессора, формирующая интерфейс взаимодействия между программным обеспечением и процессором, затрагивающая:

<div class="row"><div class="col">

1. типы данных;
1. систему регистров;
1. методы адресации;
1. модели памяти;
1. инструкции;
1. обработку прерываний и исключений;
1. методы ввода и вывода.

</div><div class="col">

![](../fig/isa-as-interface.png)<!-- .element height="275px" -->

</div></div>

Производительность, энергопотребление и задержки обычно не рассматриваются.

- [Meltdown and Spectre](https://meltdownattack.com)
- [Edward A. Lee Modeling in Engineering and Science](https://cacm.acm.org/magazines/2019/1/233519-modeling-in-engineering-and-science/fulltext)

Notes: ECE C61 Computer Architecture Lecture 3 – Instruction Set

---

### Форматы команд разных архитектур

1. MIPS32
1. Very Long Instruction Word (VLIW)
1. Stack Processor
1. Transport Triggered Architecture (TTA) Processor
1. URISC

----

#### MIPS32 процессор

![_Команда addi архитектуры MIPS32_](../fig/Mips32_addi.png)

- Первые 6 бит определяют операцию (немедленное добавление).
- Вторая и третья группы по 5 битов определяют номер одного из 32 регистров общего назначения MIPS32.
- Последние 16 бит определяют непосредственное значение.
- Значение добавляется ко второму регистру, а затем сохраняется в первом регистре.
- Если происходит арифметическое переполнение, `$r1` не изменяется и устанавливается флаг переполнения.

----

#### Very Long Instruction Word (VLIW)

![](../fig/vliw-instruction.png)

- Много инструкций за один такт.
- Длительность инструкции зависит от её типа.
- Только компилятор может создавать эффективный код.

----

#### Stack Processor

<div class="row"><div class="col">

- Данные хранятся и обрабатываются на стеке.
- Указание операндов не требуется (только сама операция).

</div><div class="col">

![](../fig/isa-stack-example.png)

</div></div>

----

#### Transport Triggered Architecture (TTA) Processor

![](../fig/tta-instruction.png)<!-- .element height="400px" -->

- Инструкции для изменения данных отсутствуют.
- Перемещение данных между "корзинами для обработки".
- Долгая обработка + быстрая пересылка $\rightarrow$ параллелизм.
- Является примером CGRA процессора.

----

### Ultimate Reduced Instruction Set Computer (URISC)

- Доступна лишь одна инструкция, но есть полнота по Тьюрингу.
- Архитектуру можно рассматривать как предельный случай RISC.
- Такой подход интересен скорее с теоретической точки зрения.

Варианты единственной инструкции:

- **RSSB** -- вычесть и пропустить следующую инструкцию, если вычитаемое было больше уменьшаемого.
- **MOV** -- переслать из первой ячейки во вторую (TTA).
- **BBJ** -- копировать один бит из первого по второму адресу памяти и передать управление на третий адрес. Последовательность инструкций может изменить значение в ячейке, на которую перейдёт управление, значит, можно выполнять вычисления, доступные обычному компьютеру.
- есть и другие.

----

### URISC. Пример

```rssb
; 0 - pc
; 1 - acc
; 2 - zero
; 3 - in
; 4 - out
; at start pc = 5

rssb acc      ; 5: acc = acc - acc = 0
rssb C        ; 6: C = acc = C - acc = 67 - 0 = 67
rssb out      ; 7: out = acc

rssb acc      ; 8: acc = acc - acc = 0
rssb S        ; 9: S = acc = S - acc = 83 - 0 = 83
rssb out      ; 10: out = acc

rssb acc      ; 11: acc = acc - acc = 0
rssb A        ; 12: A = acc = A - acc = 65 - 0 = 65
rssb out      ; 13: out = acc

rssb acc      ; 14: acc = acc - acc = 0
rssb one      ; 15: one = acc = one - acc = 1
rssb ip       ; 16: ip = acc = ip - 1 = 17 - 1 = 16, infinite loop

C rssb 67
S rssb 83
A rssb 65
one rssb 1
```

Программа Hello World: [src/helloworld.rssb](https://gitlab.se.ifmo.ru/computer-systems/csa-rolling/-/blob/master/src/helloworld.rssb)

---

## Архитектуры универсальных процессоров

<div class="row"><div class="col">

1. Машина Тьюринга
1. Редукционные компьютеры (Reduction Machines)
1. Потоковые машины (Dataflow Machines)
1. Машина фон Неймана
1. High-Level Language Computer Architecture. Stack computers
1. В стиле фон Неймана $\Longrightarrow$
1. и так далее...

</div><div class="col">

### В стиле фон Неймана

1. Гарвардская архитектура
1. CISC и микрокод
1. RISC и конвейер
1. Суперскалярные и VLIW
1. Иерархия памяти. Кеширование
1. Вводы-вывод. Прерывания
1. Параллелизм уровня команд. [S/M]I[S/M]D. SIMT. Изоляция

</div></div>

Can Programming be Liberated from the von Neumann Style? <br/> Backus, John. 1977 Turing Award Lecture

---

## Машина Тьюринга

<div class="row"><div class="col">

Машина Тьюринга включает:

- неограниченную двустороннюю ленту, разделенную на ячейки
- устройство управления (головка записи-чтения), которое может находиться в конечном числе состояний.

Управляющее устройство может:

- перемещаться по ленте влево и вправо,
- читать и записывать в ячейки символы конечного алфавита.

</div><div class="col">

![](../fig/turing_machine_fun.jpg)

</div></div>

----

1. не может быть реализована на практике
1. обладает полнотой по Тьюрингу
1. проблема остановки
1. данные и управление отделены

---

## Редукционные компьютеры

<div class="row"><div class="col">

Graph Reduction machine

![](../fig/proc-reduction-simple.png)

[An Architecture for Combinator Graph Reduction (TIGRE)](https://users.ece.cmu.edu/~koopman/tigre/index.html)

</div><div class="col">

![](../fig/proc-reduction-calls.png)

</div></div>

- В основе лямбда-исчисление и комбинаторная логика.
- Ленивая стратегия вычислений: анализ графа (программы), поиск необходимого результата, вынужденное разворачивание стека.
- Естественный параллелизм.

Notes: В аппаратуре встречается редко. Часто встречается в мире функционального программирования.

---

## Потоковые машины (Dataflow Machines)

<div class="row"><div class="col">

Dataflow architectures
: the executability and execution of instructions is solely determined based on the availability of input arguments to the instructions. The order of instruction execution is unpredictable.

- Отсутствует память как "бутылочное горлышко".
- Обычно CGRA архитектура.
- Вспоминаем расчёт артиллерийских таблиц.
- Пример:  TTA

</div><div class="col">

![](../fig/proc-dataflow-arch.jpg)

Приходите в [NITTA](https://ryukzak.github.io/projects/nitta/) -- Dataflow со стат. планированием.

</div></div>

---

## Машина фон Неймана

<div class="row"><div class="col">

- Логическое развитие машины Тьюринга.
- Ключевые отличия:
    - лента заменена на Random-Access Memory (RAM);
    - инструкции и данные объединены.
- Призвана быть максимально простой в реализации и производстве.

</div><div class="col">

![](../fig/von-neumann.png)

</div></div>

----

### Особенности машины фон Неймана

1. Использование двоичного кодирования.
    - Встречается троичное и двоично-десятичное кодирование.
1. Программное управление. Команды выполняются последовательно, одна за другой.
    - Последовательность сегодня условна.
1. Память компьютера используется для однородного хранения данных и программ.
    - Однородность сегодня спорна.
1. Ячейки памяти компьютера имеют адреса. Random-Access Memory.
    - Адрес не сводится к целому числу сегодня.
    - Память не является пассивным элементом сегодня.
1. Возможность условного перехода.
    - И сегодня им не ограничивается.

----

### Виды инструкций процессора фон Неймана

1. Работа с памятью
    - Запись констант в регистры.
    - Копирование данных между памятью и регистрами.
2. Арифметические и логические операции
    - Арифметика.
    - Битовые операции.
    - Сравнения.
    - Операции с плавающей точкой.
3. Управляющие операции
    - Безусловный и условный переходы.
    - Косвенный переход.
    - Вызов и возврат из подпрограмм.
4. Инструкции для сопроцессоров
    - Загрузка данных и получение результатов.
    - Управление операциями сопроцессора.

----

### Пример программы

Программа -- последовательность инструкций в памяти.

```text
| Address | Mnemonic       | Comment                                   |
| ------- | -------------- | ----------------------------------------- |
| 0400    | MOV CX, [0500] | CX <- [0500]                              |
| 0404    | MOV AX, 0001   | AX <- 0001                                |
| 0407    | MOV DX, 0000   | DX <- 0000                                |
| 040A    | MUL CX         | DX:AX <- AX * CX                          |
| 040C    | LOOP 040A      | Go To [040A]                              |
|         |                |   till CX->00 (CX <- CX - 1 on each step) |
| 0410    | MOV [0600], AX | [0600]<-AX                                |
| 0414    | MOV [0601], DX | [0601]<-DX                                |
| 0418    | HLT            | Stop Execution                            |
```

Факториал.

----

#### Пример процесса

Процесс -- очерёдность смены состояний процессора по мере выполнения команд.

Входные данные по адресу `0500` равны 3, выходные данные будут сохранены по адресам `[0600, 0601]`):

```text
1. {AX: -, CX: -, DX: -} Выполняется 0400 | MOV CX, [0500]
2. {AX: -, CX: 3, DX: -} Выполняется 0404 | MOV AX, 0001
3. {AX: 1, CX: 3, DX: -} Выполняется 0407 | MOV DX, 0000
    3.1. {AX: 1, CX: 3, DX: 0} Выполняется 040A | MUL CX
    3.2. {AX: 3, CX: 3, DX: 0} Выполняется 040C | LOOP 040A
                               CX не равно 0, переходим 040A.
    3.3. {AX: 3, CX: 2, DX: 0} Выполняется 040A | MUL CX
    3.4. {AX: 6, CX: 2, DX: 0} Выполняется 040C | LOOP 040A,
                               CX не равно 0, переходим 040A
    3.5. {AX: 6, CX: 1, DX: 0} Выполняется 040A | MUL CX
    3.6. {AX: 6, CX: 1, DX: 0} Выполняется 040C | LOOP 040A,
                               после декремента CX равно 0,
                               выполняем следующую инструкцию.
4. {AX: 6, CX: 0, DX: 0} Выполняется 0410 | MOV [0600], AX
5. {AX: 6, CX: 0, DX: 0} Выполняется 0414 | MOV [0601], DX
6. Выполняется 0418 | HTL, Остановить выполнение
```

----

### Процессор фон Неймана на практике

- В чистом виде практически не встречается.
- Влияние на индустрию трудно переоценить.
- Элементы архитектуры присутствуют в подавляющем большинстве процессоров и средств разработки.
- Ловушка обратной совместимости.
- Структурное (процедурное) программирование, <br/> ООП -- наследие фон Неймана.

<!--
Попытка сделать эскиз современного процессора:
![](../fig/modern-single-core-processor.png)
-->

----

### Проблемы проектирования ISA для процессора фон Неймана

1. Типы данных и их размеры (бит, кодирование, тегирование).
2. Набор команд и их взаимозаменяемость.
3. Количество операндов (1, 2 и более).
4. Расположение операндов и результата. Адресация.

<div class="row"><div class="col">

- Подразумеваемый адрес <br/> (часть Opcode)
- Непосредственная адресация (hardcode)
- Прямая адресация <br/> (указывается числом)
- Относительная (базовая) адресация (`addr + base`)

</div><div class="col">

- Укороченная адресация
- Регистровая адресация
- Косвенная адресация
- Адресация слов переменной длины
- Стековая адресация
- Автоинкрементная и автодекрементная

</div></div>
5. Кодирование инструкций. Простота декодирования и компактность.

----

### Устройство. Control Unit и DataPath

<div class="row"><div class="col">

Control Unit
: is a component of a computer's central processing unit (CPU) that directs the operation of the processor. A CU typically uses a binary decoder to convert coded instructions into timing and control signals that direct the operation of the other units.

Datapath
: is the ALU, the set of registers, and the CPU's internal bus(es) that allow data to flow between them.

</div><div class="col">

![](../fig/proc-control-unit-and-datapath.jpg)

</div></div>
